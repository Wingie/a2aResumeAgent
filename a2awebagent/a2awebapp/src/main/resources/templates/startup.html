<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>a2awebagent - Startup Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .cache-card { border-left: 4px solid #007bff; }
        .stats-card { border-left: 4px solid #28a745; }
        .tools-card { border-left: 4px solid #ffc107; }
        .model-badge { font-size: 0.9em; }
        .description-preview { max-height: 100px; overflow-y: auto; font-size: 0.85em; }
        .generation-time { color: #6c757d; font-size: 0.8em; }
        .usage-count { color: #28a745; font-weight: bold; }
        .edit-btn { font-size: 0.75em; }
        .delete-btn { font-size: 0.75em; }
        .batch-actions { background-color: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-cog"></i> a2awebagent - Startup Dashboard
            </span>
            <span class="navbar-text" th:text="'Model: ' + ${currentModel}">Current Model</span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Cache Statistics -->
            <div class="col-md-4">
                <div class="card cache-card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-database"></i> Cache Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div id="cache-stats">
                            <div class="d-flex justify-content-between">
                                <span>Total Descriptions:</span>
                                <span id="total-descriptions" class="badge bg-primary">Loading...</span>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <span>Cache Hit Rate:</span>
                                <span id="hit-rate" class="badge bg-success">Loading...</span>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <span>Current Model:</span>
                                <span class="badge bg-info model-badge" th:text="${currentModel}">deepseek/deepseek-r1-0528:free</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Provider Statistics -->
                <div class="card stats-card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Provider Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div id="provider-stats">
                            <p class="text-muted">Loading provider statistics...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tool Descriptions Management -->
            <div class="col-md-8">
                <!-- Batch Actions -->
                <div class="batch-actions">
                    <h6><i class="fas fa-tools"></i> Batch Actions</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-warning btn-sm me-2" onclick="clearCurrentModelCache()">
                                <i class="fas fa-trash"></i> Clear Current Model Cache
                            </button>
                            <button class="btn btn-info btn-sm" onclick="refreshCache()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filter-input" placeholder="Filter tools...">
                                <button class="btn btn-outline-secondary" onclick="filterTools()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tool Descriptions Table -->
                <div class="card tools-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list"></i> Cached Tool Descriptions</h5>
                        <span class="badge bg-secondary" id="tool-count">0 tools</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Tool Name</th>
                                        <th>Description Preview</th>
                                        <th>Generation Time</th>
                                        <th>Usage Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tools-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> Loading tool descriptions...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Description Modal -->
    <div class="modal fade" id="editDescriptionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Tool Description</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-form">
                        <input type="hidden" id="edit-tool-id">
                        <div class="mb-3">
                            <label for="edit-tool-name" class="form-label">Tool Name</label>
                            <input type="text" class="form-control" id="edit-tool-name" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit-description" class="form-label">Description</label>
                            <textarea class="form-control" id="edit-description" rows="8"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveDescription()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDescriptions = [];
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCacheData();
            // Auto-refresh every 30 seconds
            setInterval(loadCacheData, 30000);
        });
        
        function loadCacheData() {
            Promise.all([
                fetch('/api/cache/descriptions').then(r => r.json()),
                fetch('/api/cache/stats').then(r => r.json())
            ]).then(([descriptions, stats]) => {
                currentDescriptions = descriptions;
                updateDescriptionsTable(descriptions);
                updateStatistics(stats);
            }).catch(error => {
                console.error('Error loading cache data:', error);
                showError('Failed to load cache data');
            });
        }
        
        function updateDescriptionsTable(descriptions) {
            const tbody = document.getElementById('tools-table-body');
            const toolCount = document.getElementById('tool-count');
            
            if (descriptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No cached descriptions found</td></tr>';
                toolCount.textContent = '0 tools';
                return;
            }
            
            tbody.innerHTML = descriptions.map(desc => `
                <tr>
                    <td>
                        <strong>${desc.toolName}</strong>
                        <br><small class="text-muted">${desc.providerModel}</small>
                    </td>
                    <td>
                        <div class="description-preview">${desc.description}</div>
                    </td>
                    <td>
                        <span class="generation-time">${desc.generationTimeMs}ms</span>
                    </td>
                    <td>
                        <span class="usage-count">${desc.usageCount || 0}</span>
                    </td>
                    <td>
                        <button class="btn btn-outline-primary edit-btn me-1" onclick="editDescription(${desc.id}, '${desc.toolName}', '${desc.description}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger delete-btn" onclick="deleteDescription(${desc.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            toolCount.textContent = `${descriptions.length} tools`;
        }
        
        function updateStatistics(stats) {
            document.getElementById('total-descriptions').textContent = stats.totalDescriptions || 0;
            document.getElementById('hit-rate').textContent = (stats.hitRate || 0) + '%';
        }
        
        function editDescription(id, toolName, description) {
            document.getElementById('edit-tool-id').value = id;
            document.getElementById('edit-tool-name').value = toolName;
            document.getElementById('edit-description').value = description;
            new bootstrap.Modal(document.getElementById('editDescriptionModal')).show();
        }
        
        function saveDescription() {
            const id = document.getElementById('edit-tool-id').value;
            const description = document.getElementById('edit-description').value;
            
            fetch(`/api/cache/descriptions/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({description: description})
            }).then(response => {
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editDescriptionModal')).hide();
                    loadCacheData(); // Refresh
                    showSuccess('Description updated successfully');
                } else {
                    showError('Failed to update description');
                }
            }).catch(error => {
                console.error('Error updating description:', error);
                showError('Failed to update description');
            });
        }
        
        function deleteDescription(id) {
            if (confirm('Are you sure you want to delete this cached description?')) {
                fetch(`/api/cache/descriptions/${id}`, {method: 'DELETE'})
                .then(response => {
                    if (response.ok) {
                        loadCacheData(); // Refresh
                        showSuccess('Description deleted successfully');
                    } else {
                        showError('Failed to delete description');
                    }
                }).catch(error => {
                    console.error('Error deleting description:', error);
                    showError('Failed to delete description');
                });
            }
        }
        
        function clearCurrentModelCache() {
            const currentModel = document.querySelector('.model-badge').textContent;
            if (confirm(`Are you sure you want to clear all cached descriptions for model "${currentModel}"?`)) {
                fetch('/api/cache/clear-model', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({modelName: currentModel})
                }).then(response => {
                    if (response.ok) {
                        loadCacheData(); // Refresh
                        showSuccess('Model cache cleared successfully');
                    } else {
                        showError('Failed to clear model cache');
                    }
                }).catch(error => {
                    console.error('Error clearing cache:', error);
                    showError('Failed to clear model cache');
                });
            }
        }
        
        function refreshCache() {
            loadCacheData();
            showSuccess('Cache data refreshed');
        }
        
        function filterTools() {
            const filter = document.getElementById('filter-input').value.toLowerCase();
            const filtered = currentDescriptions.filter(desc => 
                desc.toolName.toLowerCase().includes(filter) || 
                desc.description.toLowerCase().includes(filter)
            );
            updateDescriptionsTable(filtered);
        }
        
        function showSuccess(message) {
            // Simple toast notification - could be enhanced with a proper toast library
            const toast = document.createElement('div');
            toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
            toast.style.zIndex = '9999';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function showError(message) {
            const toast = document.createElement('div');
            toast.className = 'alert alert-danger position-fixed top-0 end-0 m-3';
            toast.style.zIndex = '9999';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }
        
        // Filter on Enter key
        document.getElementById('filter-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterTools();
            }
        });
    </script>
</body>
</html>